#!/usr/bin/env bash
set -euo pipefail

# dabootstrap - Idempotent window management bootstrap for macOS
# Sets up skhd-zig + theGrid, cleans up aerospace/yabai

CONFIG_DIR="$HOME/.config"
DAMACHINE="$CONFIG_DIR/.damachine"
LAUNCH_AGENTS="$HOME/Library/LaunchAgents"
SERVICES_PLISTS="$CONFIG_DIR/services/plists"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Load machine-specific config
load_config() {
    THEGRID_DEV="${THEGRID_DEV:-false}"
    THEGRID_REPO="${THEGRID_REPO:-}"

    if [[ -f "$DAMACHINE" ]]; then
        info "Loading config from $DAMACHINE"
        source "$DAMACHINE"
    else
        info "No .damachine found, using defaults"
    fi
}

check_prerequisites() {
    info "Checking prerequisites..."

    # Check homebrew
    if ! command -v brew &>/dev/null; then
        error "Homebrew is not installed. Install from https://brew.sh"
        exit 1
    fi
    info "  Homebrew: OK"

    # Check mss
    if command -v mss &>/dev/null; then
        if mss status 2>&1 | grep -q "Loading:.*Not loaded"; then
            echo ""
            warn "╔════════════════════════════════════════════════════════════╗"
            warn "║  mss is installed but NOT LOADED                           ║"
            warn "║                                                              ║"
            warn "║  Run these commands to fix:                                  ║"
            warn "║    sudo mss load                                             ║"
            warn "║                                                              ║"
            warn "║  This requires SIP to be partially disabled.                 ║"
            warn "╚════════════════════════════════════════════════════════════╝"
            echo ""
        else
            info "  mss: OK (loaded)"
        fi
    else
        warn "  mss: not installed (optional, needed for theGrid)"
    fi
}

cleanup_aerospace() {
    info "Cleaning up aerospace..."

    local found=false

    # Stop and remove launch agent
    local plist="$LAUNCH_AGENTS/com.r.aerospace.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed launch agent"
        found=true
    fi

    # Also check for nikitabobko's default plist name
    plist="$LAUNCH_AGENTS/bobko.aerospace.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed bobko launch agent"
        found=true
    fi

    # Brew uninstall
    if brew list aerospace &>/dev/null; then
        brew uninstall aerospace
        info "  Uninstalled via brew"
        found=true
    fi

    # Untap
    if brew tap | grep -q "nikitabobko/tap"; then
        brew untap nikitabobko/tap
        info "  Untapped nikitabobko/tap"
        found=true
    fi

    if [[ "$found" == "false" ]]; then
        info "  Nothing to clean up"
    fi
}

cleanup_yabai() {
    info "Cleaning up yabai..."

    local found=false

    # Stop and remove launch agent
    local plist="$LAUNCH_AGENTS/com.koekeishiya.yabai.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed launch agent"
        found=true
    fi

    # Brew uninstall
    if brew list yabai &>/dev/null; then
        brew uninstall yabai
        info "  Uninstalled via brew"
        found=true
    fi

    # Untap
    if brew tap | grep -q "koekeishiya/formulae"; then
        brew untap koekeishiya/formulae
        info "  Untapped koekeishiya/formulae"
        found=true
    fi

    if [[ "$found" == "false" ]]; then
        info "  Nothing to clean up"
    fi
}

setup_skhd() {
    info "Setting up skhd-zig..."
    # TODO: implement
}

setup_thegrid() {
    info "Setting up theGrid..."
    # TODO: implement
}

verify_status() {
    info "Verifying services..."
    # TODO: implement
}

main() {
    echo "=== dabootstrap ==="
    echo ""

    load_config
    check_prerequisites
    cleanup_aerospace
    cleanup_yabai
    setup_skhd
    setup_thegrid
    verify_status

    echo ""
    info "Bootstrap complete!"
}

main "$@"
