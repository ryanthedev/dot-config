#!/usr/bin/env bash
set -euo pipefail

# dabootstrap - Idempotent window management bootstrap for macOS
# Sets up theGrid, cleans up legacy window managers

CONFIG_DIR="$HOME/.config"
DAMACHINE="$CONFIG_DIR/.damachine"
LAUNCH_AGENTS="$HOME/Library/LaunchAgents"
SERVICES_PLISTS="$CONFIG_DIR/services/plists"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Load machine-specific config
load_config() {
    THEGRID_DEV="${THEGRID_DEV:-false}"
    THEGRID_REPO="${THEGRID_REPO:-}"
    SKILLS_REPO="${SKILLS_REPO:-$HOME/repos/oberskills}"
    SSH_HOSTS="${SSH_HOSTS:-linode}"

    if [[ -f "$DAMACHINE" ]]; then
        info "Loading config from $DAMACHINE"
        source "$DAMACHINE"
    else
        info "No .damachine found, using defaults"
    fi
}

check_prerequisites() {
    info "Checking prerequisites..."

    # Check homebrew
    if ! command -v brew &>/dev/null; then
        error "Homebrew is not installed. Install from https://brew.sh"
        exit 1
    fi
    info "  Homebrew: OK"

    # Check mss
    if command -v mss &>/dev/null; then
        if mss status 2>&1 | grep -q "Loading:.*Not loaded"; then
            echo ""
            warn "╔════════════════════════════════════════════════════════════╗"
            warn "║  mss is installed but NOT LOADED                           ║"
            warn "║                                                              ║"
            warn "║  Run these commands to fix:                                  ║"
            warn "║    sudo mss load                                             ║"
            warn "║                                                              ║"
            warn "║  This requires SIP to be partially disabled.                 ║"
            warn "╚════════════════════════════════════════════════════════════╝"
            echo ""
        else
            info "  mss: OK (loaded)"
        fi
    else
        warn "  mss: not installed (optional, needed for theGrid)"
    fi
}

cleanup_aerospace() {
    info "Cleaning up aerospace..."

    local found=false

    # Stop and remove launch agent
    local plist="$LAUNCH_AGENTS/com.r.aerospace.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed launch agent"
        found=true
    fi

    # Also check for nikitabobko's default plist name
    plist="$LAUNCH_AGENTS/bobko.aerospace.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed bobko launch agent"
        found=true
    fi

    # Brew uninstall
    if brew list aerospace &>/dev/null; then
        brew uninstall aerospace
        info "  Uninstalled via brew"
        found=true
    fi

    # Untap
    if brew tap | grep -q "nikitabobko/tap"; then
        brew untap nikitabobko/tap
        info "  Untapped nikitabobko/tap"
        found=true
    fi

    if [[ "$found" == "false" ]]; then
        info "  Nothing to clean up"
    fi
}

cleanup_yabai() {
    info "Cleaning up yabai..."

    local found=false

    # Stop and remove launch agent
    local plist="$LAUNCH_AGENTS/com.koekeishiya.yabai.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed launch agent"
        found=true
    fi

    # Brew uninstall
    if brew list yabai &>/dev/null; then
        brew uninstall yabai
        info "  Uninstalled via brew"
        found=true
    fi

    # Untap
    if brew tap | grep -q "koekeishiya/formulae"; then
        brew untap koekeishiya/formulae
        info "  Untapped koekeishiya/formulae"
        found=true
    fi

    if [[ "$found" == "false" ]]; then
        info "  Nothing to clean up"
    fi
}

cleanup_skhd() {
    info "Cleaning up skhd..."

    local found=false

    # Stop and remove launch agent
    local plist="$LAUNCH_AGENTS/com.jackielii.skhd.plist"
    if [[ -f "$plist" ]] || [[ -L "$plist" ]]; then
        launchctl unload "$plist" 2>/dev/null || true
        rm -f "$plist"
        info "  Removed launch agent"
        found=true
    fi

    # Brew uninstall
    if brew list skhd-zig &>/dev/null; then
        brew uninstall skhd-zig
        info "  Uninstalled skhd-zig via brew"
        found=true
    fi

    # Untap
    if brew tap | grep -q "jackielii/homebrew-skhd"; then
        brew untap jackielii/homebrew-skhd
        info "  Untapped jackielii/homebrew-skhd"
        found=true
    fi

    # Remove config
    if [[ -d "$CONFIG_DIR/skhd" ]]; then
        rm -rf "$CONFIG_DIR/skhd"
        info "  Removed config directory"
        found=true
    fi

    if [[ "$found" == "false" ]]; then
        info "  Nothing to clean up"
    fi
}

setup_thegrid() {
    info "Setting up theGrid..."

    if [[ "$THEGRID_DEV" == "true" ]]; then
        setup_thegrid_dev
    else
        setup_thegrid_brew
    fi
}

setup_thegrid_dev() {
    info "  Dev mode enabled"

    # Verify repo exists
    if [[ -z "$THEGRID_REPO" ]]; then
        error "THEGRID_DEV=true but THEGRID_REPO not set in .damachine"
        exit 1
    fi

    local repo_path="${THEGRID_REPO/#\~/$HOME}"
    if [[ ! -d "$repo_path" ]]; then
        error "THEGRID_REPO does not exist: $repo_path"
        exit 1
    fi
    info "  Using repo: $repo_path"

    # Ensure services directory exists
    mkdir -p "$SERVICES_PLISTS"
    mkdir -p "$CONFIG_DIR/services/logs"

    # Generate plist for dev mode
    local plist="$SERVICES_PLISTS/com.r.thegrid-dev.plist"
    cat > "$plist" << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key>
    <string>com.r.thegrid-dev</string>
    <key>ProgramArguments</key>
    <array>
        <string>/usr/bin/make</string>
        <string>dev</string>
    </array>
    <key>WorkingDirectory</key>
    <string>$repo_path</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/usr/local/bin:/opt/homebrew/bin:/usr/bin:/bin</string>
    </dict>
    <key>RunAtLoad</key>
    <true/>
    <key>KeepAlive</key>
    <true/>
    <key>StandardOutPath</key>
    <string>$CONFIG_DIR/services/logs/thegrid-dev.log</string>
    <key>StandardErrorPath</key>
    <string>$CONFIG_DIR/services/logs/thegrid-dev.log</string>
</dict>
</plist>
EOF
    info "  Generated plist"

    # Stop brew version if running
    if brew services list | grep -q "thegrid.*started"; then
        brew services stop thegrid 2>/dev/null || true
        info "  Stopped brew thegrid service"
    fi

    # Install via services manager
    "$CONFIG_DIR/bin/services" install 2>/dev/null || true
    info "  Installed via services manager"
}

setup_thegrid_brew() {
    info "  Using brew install"

    # Stop dev service if running
    local dev_plist="$SERVICES_PLISTS/com.r.thegrid-dev.plist"
    if [[ -f "$dev_plist" ]]; then
        "$CONFIG_DIR/bin/services" stop thegrid-dev 2>/dev/null || true
        rm -f "$dev_plist"
        info "  Removed dev service"
    fi

    # Install via brew
    if ! brew tap | grep -q "ryanthedev/thegrid"; then
        brew tap ryanthedev/thegrid
    fi

    if ! brew list thegrid &>/dev/null; then
        brew install thegrid
        info "  Installed thegrid"
    else
        brew upgrade thegrid 2>/dev/null || true
        info "  thegrid upgraded (or already latest)"
    fi

    # Start service
    if ! brew services list | grep -q "thegrid.*started"; then
        brew services start thegrid
        info "  Started thegrid service"
    else
        info "  thegrid service already running"
    fi
}

setup_bin_symlinks() {
    info "Symlinking ~/.config/bin to ~/.local/bin..."

    mkdir -p "$HOME/.local/bin"

    local count=0
    for script in "$CONFIG_DIR/bin"/*; do
        [[ -f "$script" ]] || continue
        [[ -x "$script" ]] || continue
        local name
        name=$(basename "$script")
        # Skip dabootstrap itself to avoid circular issues
        [[ "$name" == "dabootstrap" ]] && continue
        ln -sf "$script" "$HOME/.local/bin/$name"
        count=$((count + 1))
    done

    info "  Linked $count scripts to ~/.local/bin"
}

setup_remote_terminfo() {
    info "Setting up Ghostty terminfo on remote hosts..."

    # Check if ghostty terminfo exists locally
    if ! infocmp xterm-ghostty &>/dev/null; then
        warn "  xterm-ghostty terminfo not found locally, skipping"
        return
    fi

    # SSH_HOSTS is space-separated list from .damachine (default: "linode")
    if [[ -z "$SSH_HOSTS" ]]; then
        info "  No SSH_HOSTS configured, skipping"
        return
    fi

    for host in $SSH_HOSTS; do
        # Check if host is reachable (with short timeout)
        if ssh -o ConnectTimeout=5 -o BatchMode=yes "$host" true 2>/dev/null; then
            info "  Installing terminfo on $host..."
            if infocmp -x xterm-ghostty | ssh "$host" tic -x - 2>/dev/null; then
                info "  $host: OK"
            else
                warn "  $host: failed to install terminfo"
            fi
        else
            warn "  $host: unreachable, skipping"
        fi
    done
}

setup_claude() {
    info "Setting up Claude Code skills..."

    local repo_path="${SKILLS_REPO/#\~/$HOME}"

    # Check if skills repo exists
    if [[ ! -d "$repo_path" ]]; then
        warn "  Skills repo not found at: $repo_path"
        warn "  Skipping Claude skills setup"
        return
    fi

    # Pull latest
    info "  Pulling latest from skills repo..."
    if git -C "$repo_path" pull --quiet 2>/dev/null; then
        info "  Updated skills repo"
    else
        warn "  Could not pull skills repo (offline or not a git repo)"
    fi

    # Create directories
    mkdir -p "$HOME/.claude/skills"
    mkdir -p "$HOME/.claude/commands"

    # Symlink global CLAUDE.md from dotfiles
    if [[ -f "$CONFIG_DIR/claude/CLAUDE.md" ]]; then
        ln -sf "$CONFIG_DIR/claude/CLAUDE.md" "$HOME/.claude/CLAUDE.md"
        info "  Linked global CLAUDE.md"
    fi

    # Symlink all skills
    local skills_dir="$repo_path/skills"
    if [[ -d "$skills_dir" ]]; then
        for skill in "$skills_dir"/*/; do
            if [[ -d "$skill" ]]; then
                local skill_name
                skill_name=$(basename "$skill")
                ln -sf "$skill" "$HOME/.claude/skills/$skill_name"
                info "  Linked skill: $skill_name"
            fi
        done
    fi

    info "  Claude skills setup complete"
}

verify_status() {
    info "Verifying services..."
    echo ""

    # theGrid
    if [[ "$THEGRID_DEV" == "true" ]]; then
        if launchctl list | grep -q "com.r.thegrid-dev"; then
            echo -e "  theGrid-dev: ${GREEN}running${NC}"
        else
            echo -e "  theGrid-dev: ${RED}not running${NC}"
        fi
    else
        if brew services list | grep -q "thegrid.*started"; then
            echo -e "  theGrid:     ${GREEN}running${NC}"
        else
            echo -e "  theGrid:     ${RED}not running${NC}"
        fi
    fi

    # mss
    if command -v mss &>/dev/null; then
        if mss status 2>&1 | grep -q "Loading:.*✓"; then
            echo -e "  mss:         ${GREEN}loaded${NC}"
        else
            echo -e "  mss:         ${YELLOW}not loaded${NC}"
        fi
    fi

    echo ""
}

main() {
    echo "=== dabootstrap ==="
    echo ""

    load_config
    check_prerequisites
    setup_bin_symlinks
    cleanup_aerospace
    cleanup_yabai
    cleanup_skhd
    setup_thegrid
    setup_remote_terminfo
    setup_claude
    verify_status

    echo ""
    info "Bootstrap complete!"
}

main "$@"
