#!/usr/bin/env bash
set -euo pipefail

# ssh-setup - Initial SSH key setup for remote hosts
# Run this once per host to set up passwordless auth, then dabootstrap handles the rest
# Keys are named after the remote host: ~/.ssh/{host}

CONFIG_DIR="$HOME/.config"
SSH_DIR="$HOME/.ssh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }

usage() {
    cat <<EOF
Usage: ssh-setup <host> [options]

Sets up SSH key authentication for a remote host.

Arguments:
  host          SSH host name (must exist in ~/.ssh/config)

Options:
  --generate    Generate a new key pair if it doesn't exist
  --terminfo    Also install Ghostty terminfo after key setup
  -h, --help    Show this help

Examples:
  ssh-setup linode                    # Copy existing key to linode
  ssh-setup linode --generate         # Generate key if needed, then copy
  ssh-setup linode --generate --terminfo  # Full setup including terminfo

EOF
}

generate_key() {
    local host=$1
    local key_path="$SSH_DIR/$host"

    if [[ -f "$key_path" ]]; then
        info "Key already exists: $key_path"
        return 0
    fi

    info "Generating new SSH key: ~/.ssh/$host"
    ssh-keygen -t ed25519 -f "$key_path" -C "$USER@$(hostname -s)â†’$host"
    info "Key generated: $key_path"

    # Update SSH config to use this key
    update_ssh_config "$host"
}

update_ssh_config() {
    local host=$1
    local config_file="$SSH_DIR/config"

    if [[ ! -f "$config_file" ]]; then
        info "Creating SSH config..."
        touch "$config_file"
        chmod 600 "$config_file"
    fi

    # Check if host block exists
    if grep -q "^Host $host\$" "$config_file" 2>/dev/null; then
        # Check if it has the right IdentityFile
        if grep -A5 "^Host $host\$" "$config_file" | grep -q "IdentityFile.*$host"; then
            info "SSH config already has correct IdentityFile for $host"
        elif grep -A5 "^Host $host\$" "$config_file" | grep -q "IdentityFile"; then
            local current_key
            current_key=$(grep -A5 "^Host $host\$" "$config_file" | grep "IdentityFile" | awk '{print $2}')
            warn "SSH config has different IdentityFile for $host"
            warn "  Current:  $current_key"
            warn "  Expected: ~/.ssh/$host"
        else
            warn "Host $host exists in config but has no IdentityFile"
            warn "Add: IdentityFile ~/.ssh/$host"
        fi
    else
        # Add new host block
        info "Adding $host to SSH config..."
        cat >> "$config_file" << EOF

Host $host
    IdentityFile ~/.ssh/$host
EOF
        info "Added host block (you'll need to add HostName and User)"
    fi
}

copy_key() {
    local host=$1
    local key_path="$SSH_DIR/${host}.pub"

    if [[ ! -f "$key_path" ]]; then
        error "Public key not found: $key_path"
        error "Run with --generate to create one"
        exit 1
    fi

    info "Copying public key to $host..."
    info "You will be prompted for your password on the remote host."
    echo ""

    ssh-copy-id -i "$key_path" "$host"

    echo ""
    info "Key copied successfully!"
}

verify_connection() {
    local host=$1

    info "Verifying passwordless connection..."
    if ssh -o BatchMode=yes -o ConnectTimeout=5 "$host" true 2>/dev/null; then
        info "Success! You can now SSH to $host without a password."
        return 0
    else
        error "Verification failed. You may still need a password."
        return 1
    fi
}

install_terminfo() {
    local host=$1

    if ! infocmp xterm-ghostty &>/dev/null; then
        warn "xterm-ghostty terminfo not found locally, skipping"
        return
    fi

    info "Installing Ghostty terminfo on $host..."
    if infocmp -x xterm-ghostty | ssh "$host" tic -x - 2>/dev/null; then
        info "Terminfo installed successfully!"
    else
        warn "Failed to install terminfo"
    fi
}

main() {
    local host=""
    local do_generate=false
    local do_terminfo=false

    while [[ $# -gt 0 ]]; do
        case $1 in
            -h|--help)
                usage
                exit 0
                ;;
            --generate)
                do_generate=true
                shift
                ;;
            --terminfo)
                do_terminfo=true
                shift
                ;;
            -*)
                error "Unknown option: $1"
                usage
                exit 1
                ;;
            *)
                if [[ -z "$host" ]]; then
                    host=$1
                else
                    error "Too many arguments"
                    usage
                    exit 1
                fi
                shift
                ;;
        esac
    done

    if [[ -z "$host" ]]; then
        error "Host argument required"
        usage
        exit 1
    fi

    # Check if host exists in ssh config
    if ! grep -q "^Host $host\$" "$SSH_DIR/config" 2>/dev/null; then
        warn "Host '$host' not found in ~/.ssh/config"
        warn "You may need to add it first. Example:"
        echo ""
        echo "Host $host"
        echo "    HostName <ip-or-hostname>"
        echo "    User <username>"
        echo "    IdentityFile ~/.ssh/$host"
        echo ""
        read -p "Continue anyway? [y/N] " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            exit 1
        fi
    fi

    echo "=== SSH Setup: $host ==="
    echo ""

    if [[ "$do_generate" == true ]]; then
        generate_key "$host"
    fi

    copy_key "$host"
    verify_connection "$host"

    if [[ "$do_terminfo" == true ]]; then
        install_terminfo "$host"
    fi

    echo ""
    info "Setup complete for $host!"
}

main "$@"
